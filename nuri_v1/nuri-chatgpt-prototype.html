<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nuri - ChatGPT-like Design Prototype</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        /* Custom Nuri Brand Colors - Comprehensive Green Palette */
        :root {
            /* Main Brand Green Palette */
            --nuri-primary: #00AF9F;           /* Main brand green */
            --nuri-primary-hover: #009688;     /* Darker green for hover */
            --nuri-primary-light: #4DD0E1;     /* Light green for accents */
            --nuri-primary-lighter: #80E5FF;   /* Very light green */
            --nuri-primary-dark: #00695C;      /* Dark green for emphasis */

            /* Background Greens */
            --nuri-bg-light: #F5FFFE;          /* Subtle light background - consistent with V2 */
            --nuri-bg-medium: #B2EBF2;         /* Medium light background */
            --nuri-bg-dark: #4DB6AC;           /* Medium background */

            /* Icon Greens - Harmonious variations */
            --nuri-icon-primary: #00AF9F;      /* Primary icons */
            --nuri-icon-secondary: #26A69A;    /* Secondary icons */
            --nuri-icon-tertiary: #4DD0E1;     /* Tertiary icons */
            --nuri-icon-light: #80CBC4;        /* Light icons */

            /* Button Greens - Consistent system */
            --nuri-btn-primary: #00AF9F;       /* Primary buttons */
            --nuri-btn-primary-hover: #009688; /* Primary button hover */
            --nuri-btn-secondary: #26A69A;     /* Secondary buttons */
            --nuri-btn-secondary-hover: #00695C; /* Secondary button hover */
        }

        /* ChatGPT-like font family */
        body {
            font-family: "SÃ¶hne", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        
        /* Comprehensive Green Palette Utility Classes */

        /* Background Colors */
        .bg-nuri-primary { background-color: var(--nuri-primary); }
        .bg-nuri-primary-light { background-color: var(--nuri-primary-light); }
        .bg-nuri-primary-lighter { background-color: var(--nuri-primary-lighter); }
        .bg-nuri-primary-dark { background-color: var(--nuri-primary-dark); }
        .bg-nuri-bg-light { background-color: var(--nuri-bg-light); }
        .bg-nuri-bg-medium { background-color: var(--nuri-bg-medium); }
        .bg-nuri-bg-dark { background-color: var(--nuri-bg-dark); }

        /* Text Colors */
        .text-nuri-primary { color: var(--nuri-primary); }
        .text-nuri-primary-light { color: var(--nuri-primary-light); }
        .text-nuri-primary-dark { color: var(--nuri-primary-dark); }
        .text-nuri-icon-primary { color: var(--nuri-icon-primary); }
        .text-nuri-icon-secondary { color: var(--nuri-icon-secondary); }
        .text-nuri-icon-tertiary { color: var(--nuri-icon-tertiary); }
        .text-nuri-icon-light { color: var(--nuri-icon-light); }

        /* Border Colors */
        .border-nuri-primary { border-color: var(--nuri-primary); }
        .border-nuri-primary-light { border-color: var(--nuri-primary-light); }
        .border-nuri-bg-medium { border-color: var(--nuri-bg-medium); }

        /* Hover States */
        .hover\:bg-nuri-primary:hover { background-color: var(--nuri-primary-hover); }
        .hover\:bg-nuri-primary-light:hover { background-color: var(--nuri-primary); }
        .hover\:text-nuri-primary:hover { color: var(--nuri-primary); }
        .hover\:text-nuri-primary-dark:hover { color: var(--nuri-primary-dark); }

        /* Button System - Consistent across app */
        .btn-nuri-primary {
            background-color: var(--nuri-btn-primary);
            color: white;
            transition: background-color 0.2s ease;
        }
        .btn-nuri-primary:hover {
            background-color: var(--nuri-btn-primary-hover);
        }
        .btn-nuri-secondary {
            background-color: var(--nuri-btn-secondary);
            color: white;
            transition: background-color 0.2s ease;
        }
        .btn-nuri-secondary:hover {
            background-color: var(--nuri-btn-secondary-hover);
        }
        
        /* Sidebar animations */
        .sidebar-transition {
            transition: transform 0.3s ease-in-out, width 0.3s ease-in-out;
        }

        /* Collapsed sidebar styles */
        .sidebar-collapsed {
            width: 64px !important;
        }

        .sidebar-collapsed .sidebar-content {
            opacity: 0;
            pointer-events: none;
        }

        .sidebar-collapsed .sidebar-icons {
            opacity: 1;
            pointer-events: auto;
        }

        .sidebar-icons {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out;
        }

        /* Ensure logo is always clickable in collapsed state */
        .sidebar-collapsed .sidebar-icons #logoToggle {
            pointer-events: auto;
        }

        .sidebar-content {
            transition: opacity 0.3s ease-in-out;
        }

        /* Logo hover effect */
        .logo-hover-toggle {
            transition: opacity 0.2s ease-in-out;
            pointer-events: none; /* Prevent hover overlay from blocking clicks */
        }

        /* Main content transition */
        .main-content-transition {
            transition: margin-left 0.3s ease-in-out;
        }

        /* Desktop collapsed state adjustments */
        @media (min-width: 1024px) {
            .sidebar-collapsed + .main-content-transition {
                margin-left: 64px;
            }
        }

        /* Main content transition for sidebar collapse */
        .main-content-transition {
            transition: margin-left 0.3s ease-in-out;
        }
        
        /* Message animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message-animate {
            animation: fadeInUp 0.3s ease-out;
        }
        
        /* Typing indicator */
        @keyframes bounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }
        
        .typing-dot {
            animation: bounce 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* Mobile bottom sheet */
        .bottom-sheet {
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
        }
        
        .bottom-sheet.open {
            transform: translateY(0);
        }

        /* State transition animations */
        .state-transition {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Initial state styling */
        #initialState {
            transition: opacity 0.3s ease-in-out;
        }

        #conversationState {
            transition: opacity 0.3s ease-in-out;
        }

        /* Mobile input positioning - ChatGPT style */
        @media (max-width: 767px) {
            /* Make initial state input stick to bottom on mobile */
            #initialState {
                display: flex;
                flex-direction: column;
                justify-content: space-between;
                padding-bottom: 120px; /* Account for fixed input */
                padding-top: 2rem;
            }

            #initialState .max-w-3xl {
                display: flex;
                flex-direction: column;
                height: 100%;
            }

            #initialState .text-center {
                flex: 1;
                display: flex;
                flex-direction: column;
                justify-content: center;
                margin-bottom: 0;
            }

            /* Position mobile input at bottom */
            .mobile-bottom-input {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: white;
                padding: 16px;
                z-index: 30;
            }

            /* Hide desktop inputs on mobile */
            #initialState .max-w-3xl.mx-auto.mb-8 {
                display: none !important;
            }

            /* Adjust conversation input for mobile */
            #conversationInput {
                display: none !important;
            }

            /* Add padding to conversation state to account for fixed input */
            #conversationState {
                padding-bottom: 120px !important;
            }

            /* Ensure main content area accounts for fixed input */
            .mobile-content-padding {
                padding-bottom: 120px;
            }

            /* Hide desktop input on mobile */
            #initialState .hidden.md\\:block {
                display: none !important;
            }

            /* Adjust mobile header to account for fixed input */
            .lg\\:hidden {
                position: relative;
                z-index: 40;
            }
        }
    </style>
</head>
<body class="bg-white font-sans">
    <!-- Main Container -->
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <div id="sidebar" class="sidebar-transition fixed inset-y-0 left-0 z-50 w-80 bg-gray-50 border-r border-gray-200 transform -translate-x-full lg:translate-x-0 lg:static lg:inset-0">
            <!-- Expanded Sidebar Content -->
            <div class="sidebar-content">
                <!-- Sidebar Header -->
                <div class="flex items-center justify-between p-4 border-b border-gray-200">
                    <div class="flex items-center space-x-2">
                        <div class="relative group">
                            <div class="w-8 h-8 flex items-center justify-center cursor-pointer" id="logoToggleExpanded">
                                <img src="nuri_logo.svg" alt="Nuri Logo" class="w-6 h-8">
                            </div>
                            <!-- Toggle icon on hover for expanded state -->
                            <div class="absolute inset-0 flex items-center justify-center bg-gray-50 rounded-md opacity-0 group-hover:opacity-100 logo-hover-toggle">
                                <i data-lucide="panel-left-close" class="w-5 h-5 text-gray-600"></i>
                            </div>
                        </div>
                        <span class="text-lg font-semibold text-nuri-primary-dark">Nuri</span>
                    </div>
                    <div class="flex items-center space-x-1">
                        <!-- Desktop sidebar close button -->
                        <button id="sidebarCollapseDesktop" class="hidden lg:block p-1 rounded-md hover:bg-gray-200 text-gray-600 hover:text-gray-800" title="Close sidebar">
                            <i data-lucide="panel-left-close" class="w-5 h-5"></i>
                        </button>
                        <!-- Mobile sidebar close button -->
                        <button id="sidebarClose" class="lg:hidden p-1 rounded-md hover:bg-gray-200">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>

            <!-- Top Group: New Chat & Search -->
            <div class="p-4 border-b border-gray-200">
                <div class="space-y-1">
                    <button id="new-chat" onclick="loadChatPage()" class="w-full flex items-center space-x-3 p-2 rounded-lg hover:bg-nuri-bg-medium hover:text-nuri-primary-dark text-gray-700 text-left nav-button">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                        <span class="text-sm">New Chat</span>
                    </button>
                    <button onclick="openSearchDialog()" class="w-full flex items-center space-x-3 p-2 rounded-lg hover:bg-nuri-bg-medium hover:text-nuri-primary-dark text-gray-700 text-left">
                        <i data-lucide="search" class="w-4 h-4"></i>
                        <span class="text-sm">Search chats</span>
                    </button>
                </div>
            </div>

            <!-- Tools Group -->
            <div class="px-4 pb-4 border-b border-gray-200">
                <div class="space-y-1">
                    <button id="wellness-tool" onclick="loadToolPage('wellness')" class="w-full flex items-center space-x-3 p-2 rounded-lg hover:bg-nuri-bg-medium hover:text-nuri-primary-dark text-gray-700 text-left tool-button">
                        <i data-lucide="heart" class="w-4 h-4"></i>
                        <span class="text-sm">Wellness Tools</span>
                    </button>
                    <button id="nutrition-tool" onclick="loadToolPage('nutrition')" class="w-full flex items-center space-x-3 p-2 rounded-lg hover:bg-nuri-bg-medium hover:text-nuri-primary-dark text-gray-700 text-left tool-button">
                        <i data-lucide="apple" class="w-4 h-4"></i>
                        <span class="text-sm">Nutrition Tools</span>
                    </button>
                    <button id="exercise-tool" onclick="loadToolPage('exercise')" class="w-full flex items-center space-x-3 p-2 rounded-lg hover:bg-nuri-bg-medium hover:text-nuri-primary-dark text-gray-700 text-left tool-button">
                        <i data-lucide="dumbbell" class="w-4 h-4"></i>
                        <span class="text-sm">Exercise Tools</span>
                    </button>
                </div>
            </div>

            <!-- Chats Group -->
            <div class="px-4 pb-4">
                <h3 class="text-sm font-medium text-gray-700 mb-3">Chats</h3>
                <div class="space-y-1">
                    <div onclick="selectChat(this)" class="flex items-center space-x-3 p-2 rounded-lg hover:bg-nuri-bg-medium hover:text-nuri-primary-dark text-gray-600 cursor-pointer">
                        <i data-lucide="message-circle" class="w-4 h-4"></i>
                        <span class="text-sm truncate">Nutrition planning help</span>
                    </div>
                    <div onclick="selectChat(this)" class="flex items-center space-x-3 p-2 rounded-lg hover:bg-nuri-bg-medium hover:text-nuri-primary-dark text-gray-600 cursor-pointer">
                        <i data-lucide="message-circle" class="w-4 h-4"></i>
                        <span class="text-sm truncate">Mood tracking insights</span>
                    </div>
                    <div onclick="selectChat(this)" class="flex items-center space-x-3 p-2 rounded-lg hover:bg-nuri-bg-medium hover:text-nuri-primary-dark text-gray-600 cursor-pointer">
                        <i data-lucide="message-circle" class="w-4 h-4"></i>
                        <span class="text-sm truncate">Fasting schedule setup</span>
                    </div>
                    <div onclick="selectChat(this)" class="flex items-center space-x-3 p-2 rounded-lg hover:bg-nuri-bg-medium hover:text-nuri-primary-dark text-gray-600 cursor-pointer">
                        <i data-lucide="message-circle" class="w-4 h-4"></i>
                        <span class="text-sm truncate">Exercise routine planning</span>
                    </div>
                </div>
            </div>
            
            <!-- Sidebar Footer -->
            <div class="absolute bottom-0 left-0 right-0 p-4">
                <div class="relative">
                    <button id="profileMenuButton" class="w-full flex items-center space-x-3 p-2 rounded-lg hover:bg-nuri-bg-medium hover:text-nuri-primary-dark text-gray-700 text-left">
                        <div id="userAvatar" class="w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-medium" style="background-color: #10a37f;">
                            JD
                        </div>
                        <div class="flex-1">
                            <div class="text-sm font-medium">John Doe</div>
                            <div class="text-xs text-gray-500">Free</div>
                        </div>
                        <i data-lucide="more-horizontal" class="w-4 h-4"></i>
                    </button>

                    <!-- Profile Dropdown Menu -->
                    <div id="profileDropdown" class="hidden absolute bottom-full left-0 right-0 mb-2 bg-white border border-gray-200 rounded-lg shadow-lg">
                        <div class="py-1">
                            <button onclick="openModal('settings')" class="w-full flex items-center space-x-3 px-3 py-2 text-left hover:bg-nuri-bg-medium hover:text-nuri-primary-dark text-gray-700">
                                <i data-lucide="settings" class="w-4 h-4"></i>
                                <span class="text-sm">Settings</span>
                            </button>
                            <div class="border-t border-gray-100"></div>
                            <button class="w-full flex items-center space-x-3 px-3 py-2 text-left hover:bg-nuri-bg-medium hover:text-nuri-primary-dark text-gray-700">
                                <i data-lucide="log-out" class="w-4 h-4"></i>
                                <span class="text-sm">Log out</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            </div>

            <!-- Collapsed Sidebar Icons -->
            <div class="sidebar-icons absolute inset-0 flex flex-col">
                <!-- Logo with hover toggle -->
                <div class="p-4 border-b border-gray-200 flex justify-center">
                    <div class="relative group">
                        <div class="w-8 h-8 flex items-center justify-center cursor-pointer" id="logoToggle">
                            <img src="nuri_logo.svg" alt="Nuri Logo" class="w-6 h-8">
                        </div>
                        <!-- Toggle icon on hover -->
                        <div class="absolute inset-0 flex items-center justify-center bg-gray-50 rounded-md opacity-0 group-hover:opacity-100 logo-hover-toggle">
                            <i data-lucide="panel-left-open" class="w-5 h-5 text-gray-600"></i>
                        </div>
                    </div>
                </div>

                <!-- Icon buttons -->
                <div class="p-2 border-b border-gray-200 space-y-1">
                    <button onclick="loadChatPage()" class="w-full p-2 rounded-lg hover:bg-nuri-bg-medium hover:text-nuri-primary-dark text-gray-700 flex justify-center" title="New Chat">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                    </button>
                    <button onclick="openSearchDialog()" class="w-full p-2 rounded-lg hover:bg-nuri-bg-medium hover:text-nuri-primary-dark text-gray-700 flex justify-center" title="Search chats">
                        <i data-lucide="search" class="w-5 h-5"></i>
                    </button>
                </div>

                <!-- Tool icons -->
                <div class="p-2 space-y-1">
                    <button onclick="loadToolPage('wellness')" class="w-full p-2 rounded-lg hover:bg-nuri-bg-medium hover:text-nuri-primary-dark text-gray-700 flex justify-center" title="Wellness Tools">
                        <i data-lucide="heart" class="w-5 h-5"></i>
                    </button>
                    <button onclick="loadToolPage('nutrition')" class="w-full p-2 rounded-lg hover:bg-nuri-bg-medium hover:text-nuri-primary-dark text-gray-700 flex justify-center" title="Nutrition Tools">
                        <i data-lucide="apple" class="w-5 h-5"></i>
                    </button>
                    <button onclick="loadToolPage('exercise')" class="w-full p-2 rounded-lg hover:bg-nuri-bg-medium hover:text-nuri-primary-dark text-gray-700 flex justify-center" title="Exercise Tools">
                        <i data-lucide="dumbbell" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Sidebar Overlay for Mobile -->
        <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden hidden"></div>

        <!-- Main Content Area -->
        <div class="flex-1 flex flex-col lg:ml-0 main-content-transition">
            <!-- Mobile Header -->
            <div class="lg:hidden flex items-center justify-between p-4 border-b border-gray-200 bg-white">
                <button id="sidebarToggle" class="p-2 rounded-md hover:bg-gray-100">
                    <i data-lucide="menu" class="w-5 h-5"></i>
                </button>
                <span id="mobileTitle" class="font-semibold text-nuri-primary-dark">Nuri Assistant</span>
                <div class="flex items-center space-x-2">
                    <!-- Account icon removed -->
                </div>
            </div>



            <!-- Main Content Area -->
            <div class="flex-1 overflow-y-auto custom-scrollbar">
                <!-- Chat Page -->
                <div id="chatPage" class="h-full">
                    <!-- Initial State - Centered Welcome -->
                    <div id="initialState" class="h-full flex flex-col items-center justify-center p-8 md:p-8">
                        <div class="w-full max-w-3xl mx-auto">
                            <!-- Logo and Title -->
                            <div class="text-center mb-8">
                                <div class="w-12 h-12 flex items-center justify-center mx-auto mb-4">
                                    <img src="nuri_logo.svg" alt="Nuri Logo" class="w-9 h-12">
                                </div>
                                <h1 class="text-3xl font-semibold text-nuri-primary-dark mb-8">What can I help with?</h1>
                            </div>

                            <!-- Centered Input - Desktop, Bottom Input - Mobile -->
                            <div class="max-w-3xl mx-auto mb-8 md:mb-8 hidden md:block">
                                <div class="relative">
                                    <textarea
                                        id="initialMessageInput"
                                        placeholder="Message Nuri"
                                        class="w-full px-4 py-4 pr-12 border border-gray-300 rounded-3xl focus:outline-none focus:ring-0 focus:border-gray-300 resize-none bg-white text-gray-900 shadow-sm text-base"
                                        rows="1"
                                        style="max-height: 200px; min-height: 56px; font-size: 16px; line-height: 24px;"
                                    ></textarea>
                                    <div class="absolute right-3 top-1/2 transform -translate-y-1/2 flex items-center space-x-2">
                                        <button class="p-1.5 text-gray-400 hover:text-gray-600 rounded-md hover:bg-gray-100">
                                            <i data-lucide="paperclip" class="w-4 h-4"></i>
                                        </button>
                                        <button
                                            id="initialSendButton"
                                            class="p-1.5 bg-gray-200 text-gray-400 rounded-lg hover:bg-gray-300 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                            disabled
                                        >
                                            <i data-lucide="arrow-up" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="mt-3 text-xs text-gray-500 text-center">
                                    Nuri can make mistakes. Check important info.
                                </div>
                            </div>


                        </div>
                    </div>

                    <!-- Conversation State - Chat Messages -->
                    <div id="conversationState" class="hidden p-4 space-y-6">
                        <!-- Messages will be dynamically added here -->
                        <div id="messagesContainer" class="max-w-4xl mx-auto space-y-6">
                            <!-- Messages will be inserted here -->
                        </div>
                    </div>
                </div>

                <!-- Tool Pages (will be loaded dynamically) -->
                <div id="toolPage" class="hidden h-full">
                    <iframe id="toolFrame" class="w-full h-full border-0"></iframe>
                </div>
            </div>

            <!-- Conversation Input Area (hidden initially) -->
            <div id="conversationInput" class="hidden p-4 bg-white md:relative">
                <div class="max-w-4xl mx-auto">
                    <div class="relative">
                        <textarea
                            id="messageInput"
                            placeholder="Message Nuri"
                            class="w-full px-4 py-4 pr-16 border border-gray-300 rounded-3xl focus:outline-none focus:ring-0 focus:border-gray-300 resize-none bg-white text-gray-900 shadow-sm text-base"
                            rows="1"
                            style="max-height: 200px; min-height: 56px; font-size: 16px; line-height: 24px;"
                        ></textarea>
                        <div class="absolute right-3 top-1/2 transform -translate-y-1/2 flex items-center space-x-2">
                            <button class="p-1.5 text-gray-400 hover:text-gray-600 rounded-md hover:bg-gray-100">
                                <i data-lucide="paperclip" class="w-4 h-4"></i>
                            </button>
                            <button
                                id="sendButton"
                                class="p-1.5 bg-gray-200 text-gray-400 rounded-lg hover:bg-gray-300 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                disabled
                            >
                                <i data-lucide="arrow-up" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mt-3 text-xs text-gray-500 text-center hidden md:block">
                        Nuri can make mistakes. Check important info.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Bottom Input Areas (ChatGPT Style) -->
    <!-- Mobile Initial Input (shown only on mobile when in initial state) -->
    <div id="mobileInitialInput" class="md:hidden mobile-bottom-input">
        <div class="max-w-3xl mx-auto">
            <div class="relative">
                <textarea
                    id="mobileInitialMessageInput"
                    placeholder="Message Nuri"
                    class="w-full px-4 py-4 pr-12 border border-gray-300 rounded-3xl focus:outline-none focus:ring-0 focus:border-gray-300 resize-none bg-white text-gray-900 shadow-sm text-base"
                    rows="1"
                    style="max-height: 200px; min-height: 56px; font-size: 16px; line-height: 24px;"
                ></textarea>
                <div class="absolute right-3 top-1/2 transform -translate-y-1/2 flex items-center space-x-2">
                    <button class="p-1.5 text-gray-400 hover:text-gray-600 rounded-md hover:bg-gray-100">
                        <i data-lucide="paperclip" class="w-4 h-4"></i>
                    </button>
                    <button
                        id="mobileInitialSendButton"
                        class="p-1.5 bg-gray-200 text-gray-400 rounded-lg hover:bg-gray-300 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled
                    >
                        <i data-lucide="arrow-up" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
            <div class="mt-3 text-xs text-gray-500 text-center">
                Nuri can make mistakes. Check important info.
            </div>
        </div>
    </div>

    <!-- Mobile Conversation Input (shown only on mobile when in conversation state) -->
    <div id="mobileConversationInput" class="md:hidden mobile-bottom-input hidden">
        <div class="max-w-3xl mx-auto">
            <div class="relative">
                <textarea
                    id="mobileMessageInput"
                    placeholder="Message Nuri"
                    class="w-full px-4 py-4 pr-12 border border-gray-300 rounded-3xl focus:outline-none focus:ring-0 focus:border-gray-300 resize-none bg-white text-gray-900 shadow-sm text-base"
                    rows="1"
                    style="max-height: 200px; min-height: 56px; font-size: 16px; line-height: 24px;"
                ></textarea>
                <div class="absolute right-3 top-1/2 transform -translate-y-1/2 flex items-center space-x-2">
                    <button class="p-1.5 text-gray-400 hover:text-gray-600 rounded-md hover:bg-gray-100">
                        <i data-lucide="paperclip" class="w-4 h-4"></i>
                    </button>
                    <button
                        id="mobileSendButton"
                        class="p-1.5 bg-gray-200 text-gray-400 rounded-lg hover:bg-gray-300 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled
                    >
                        <i data-lucide="arrow-up" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
            <div class="mt-3 text-xs text-gray-500 text-center">
                Nuri can make mistakes. Check important info.
            </div>
        </div>
    </div>

    <!-- Modal Container for Feature Modals -->
    <div id="modalContainer" class="hidden fixed inset-0 z-50">
        <iframe id="modalFrame" class="w-full h-full border-0"></iframe>
    </div>

    <!-- Search Dialog -->
    <div id="searchDialog" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 pt-20">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-4 max-h-[80vh] overflow-hidden">
            <!-- Search Header -->
            <div class="flex items-center p-4 border-b border-gray-200">
                <div class="flex-1 relative">
                    <input
                        type="text"
                        id="searchInput"
                        placeholder="Search chats..."
                        class="w-full px-4 py-3 text-base bg-transparent border-none outline-none text-gray-900 placeholder-gray-500"
                        autocomplete="off"
                    >
                </div>
                <button onclick="closeSearchDialog()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                    <i data-lucide="x" class="w-5 h-5 text-gray-500"></i>
                </button>
            </div>

            <!-- Search Results -->
            <div class="max-h-96 overflow-y-auto">
                <div id="searchResults" class="py-2">
                    <!-- Default results when no search -->
                    <div class="px-4 py-2">
                        <div class="flex items-center space-x-3 p-3 hover:bg-gray-100 rounded-lg cursor-pointer" onclick="loadChatPage(); closeSearchDialog();">
                            <i data-lucide="plus" class="w-4 h-4 text-gray-500"></i>
                            <span class="text-sm text-gray-900">New chat</span>
                        </div>
                    </div>

                    <!-- Chat History Section -->
                    <div class="px-4 py-2">
                        <div class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2 px-3">Today</div>
                        <div class="space-y-1">
                            <div class="flex items-center space-x-3 p-3 hover:bg-gray-100 rounded-lg cursor-pointer">
                                <i data-lucide="message-circle" class="w-4 h-4 text-gray-500"></i>
                                <span class="text-sm text-gray-900">Nutrition planning help</span>
                            </div>
                            <div class="flex items-center space-x-3 p-3 hover:bg-gray-100 rounded-lg cursor-pointer">
                                <i data-lucide="message-circle" class="w-4 h-4 text-gray-500"></i>
                                <span class="text-sm text-gray-900">Mood tracking insights</span>
                            </div>
                        </div>
                    </div>

                    <div class="px-4 py-2">
                        <div class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2 px-3">Yesterday</div>
                        <div class="space-y-1">
                            <div class="flex items-center space-x-3 p-3 hover:bg-gray-100 rounded-lg cursor-pointer">
                                <i data-lucide="message-circle" class="w-4 h-4 text-gray-500"></i>
                                <span class="text-sm text-gray-900">Fasting schedule setup</span>
                            </div>
                            <div class="flex items-center space-x-3 p-3 hover:bg-gray-100 rounded-lg cursor-pointer">
                                <i data-lucide="message-circle" class="w-4 h-4 text-gray-500"></i>
                                <span class="text-sm text-gray-900">Exercise routine planning</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // DOM elements
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebarClose = document.getElementById('sidebarClose');
        const mobileTitle = document.getElementById('mobileTitle');

        // Page elements
        const chatPage = document.getElementById('chatPage');
        const toolPage = document.getElementById('toolPage');
        const toolFrame = document.getElementById('toolFrame');

        // Initial state elements
        const initialState = document.getElementById('initialState');
        const initialMessageInput = document.getElementById('initialMessageInput');
        const initialSendButton = document.getElementById('initialSendButton');
        const initialSuggestionBtns = document.querySelectorAll('.suggestion-btn-initial');

        // Mobile initial state elements
        const mobileInitialInput = document.getElementById('mobileInitialInput');
        const mobileInitialMessageInput = document.getElementById('mobileInitialMessageInput');
        const mobileInitialSendButton = document.getElementById('mobileInitialSendButton');

        // Mobile conversation state elements
        const mobileConversationInput = document.getElementById('mobileConversationInput');
        const mobileMessageInput = document.getElementById('mobileMessageInput');
        const mobileSendButton = document.getElementById('mobileSendButton');

        // Conversation state elements
        const conversationState = document.getElementById('conversationState');
        const conversationInput = document.getElementById('conversationInput');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const messagesContainer = document.getElementById('messagesContainer');

        // Sidebar functionality
        function openSidebar() {
            sidebar.classList.remove('-translate-x-full');
            sidebarOverlay.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
        }

        function closeSidebar() {
            sidebar.classList.add('-translate-x-full');
            sidebarOverlay.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
        }

        // Desktop sidebar collapse functionality
        let sidebarCollapsed = false;
        const sidebarCollapseDesktop = document.getElementById('sidebarCollapseDesktop');
        const mainContent = document.querySelector('.main-content-transition');

        function toggleDesktopSidebar() {
            if (sidebarCollapsed) {
                // Expand sidebar
                sidebar.classList.remove('-translate-x-full');
                sidebar.classList.remove('lg:-translate-x-full');
                if (mainContent) {
                    mainContent.classList.remove('lg:ml-0');
                }
                sidebarCollapseDesktop.innerHTML = '<i data-lucide="panel-left-close" class="w-5 h-5"></i>';
                sidebarCollapseDesktop.title = 'Close sidebar';
                sidebarCollapsed = false;
            } else {
                // Collapse sidebar
                sidebar.classList.add('lg:-translate-x-full');
                if (mainContent) {
                    mainContent.classList.add('lg:ml-0');
                }
                sidebarCollapseDesktop.innerHTML = '<i data-lucide="panel-left-open" class="w-5 h-5"></i>';
                sidebarCollapseDesktop.title = 'Open sidebar';
                sidebarCollapsed = true;
            }
            // Re-initialize Lucide icons
            lucide.createIcons();
        }

        // Desktop sidebar collapse functionality
        let isDesktopSidebarCollapsed = false;

        function toggleDesktopSidebar() {
            isDesktopSidebarCollapsed = !isDesktopSidebarCollapsed;

            if (isDesktopSidebarCollapsed) {
                sidebar.classList.add('sidebar-collapsed');
            } else {
                sidebar.classList.remove('sidebar-collapsed');
            }

            // Re-initialize Lucide icons after DOM changes
            setTimeout(() => {
                lucide.createIcons();
            }, 100);
        }

        sidebarToggle?.addEventListener('click', openSidebar);
        sidebarClose?.addEventListener('click', closeSidebar);
        sidebarOverlay?.addEventListener('click', closeSidebar);
        sidebarCollapseDesktop?.addEventListener('click', toggleDesktopSidebar);

        // Logo toggle functionality for both states
        const logoToggleExpanded = document.getElementById('logoToggleExpanded');
        const logoToggleCollapsed = document.getElementById('logoToggle');

        logoToggleExpanded?.addEventListener('click', toggleDesktopSidebar);
        logoToggleCollapsed?.addEventListener('click', toggleDesktopSidebar);

        // Page management
        let currentPage = 'chat';

        function loadChatPage() {
            currentPage = 'chat';

            // Show chat page, hide tool page
            chatPage.classList.remove('hidden');
            toolPage.classList.add('hidden');

            // Reset to initial state
            isInitialState = true;
            initialState.classList.remove('hidden');
            conversationState.classList.add('hidden');
            conversationInput.classList.add('hidden');

            // Show mobile initial input, hide mobile conversation input
            if (mobileInitialInput) {
                mobileInitialInput.classList.remove('hidden');
            }
            if (mobileConversationInput) {
                mobileConversationInput.classList.add('hidden');
            }

            // Clear messages
            messagesContainer.innerHTML = '';

            // Clear inputs (both desktop and mobile)
            if (initialMessageInput) {
                initialMessageInput.value = '';
                initialSendButton.disabled = true;
            }
            if (mobileInitialMessageInput) {
                mobileInitialMessageInput.value = '';
                mobileInitialSendButton.disabled = true;
            }
            if (messageInput) {
                messageInput.value = '';
                sendButton.disabled = true;
            }

            // Update mobile title
            mobileTitle.textContent = 'Nuri Assistant';

            // Clear all navigation highlighting (New Chat should never be highlighted)
            updateNavigationHighlight('none');

            // Close sidebar on mobile when item is selected
            if (window.innerWidth < 1024) {
                closeSidebar();
            }
        }

        // Sample conversation data
        const sampleConversations = {
            'Nutrition planning help': [
                { message: "Hi Nuri! I need help planning my meals for the week. I'm trying to eat healthier but I'm not sure where to start.", isUser: true },
                { message: "I'd be happy to help you plan nutritious meals! Let me start by asking a few questions to personalize your meal plan. What are your main health goals right now?", isUser: false },
                { message: "I want to lose about 10 pounds and have more energy throughout the day. I also have a pretty busy schedule, so I need something simple.", isUser: true },
                { message: "Perfect! For weight loss and sustained energy, I recommend focusing on balanced meals with lean proteins, complex carbs, and healthy fats. Here's a simple weekly plan:\n\n**Breakfast ideas:**\nâ¢ Greek yogurt with berries and nuts\nâ¢ Overnight oats with chia seeds\nâ¢ Veggie omelet with whole grain toast\n\n**Lunch/Dinner:**\nâ¢ Grilled chicken with quinoa and roasted vegetables\nâ¢ Salmon with sweet potato and steamed broccoli\nâ¢ Turkey and avocado wrap with mixed greens\n\nWould you like me to create a detailed shopping list for these meals?", isUser: false },
                { message: "Yes, that would be amazing! And can you suggest some healthy snacks too?", isUser: true },
                { message: "Absolutely! Here are some energy-boosting snacks:\n\n**Quick & Healthy Snacks:**\nâ¢ Apple slices with almond butter\nâ¢ Hummus with carrot sticks\nâ¢ Mixed nuts and seeds\nâ¢ Greek yogurt with a drizzle of honey\nâ¢ Hard-boiled eggs\n\nI'll prepare a complete shopping list organized by food categories. These snacks will help maintain your energy levels between meals while supporting your weight loss goals.", isUser: false }
            ],
            'Mood tracking insights': [
                { message: "I've been feeling pretty stressed lately and my mood has been all over the place. Can you help me understand what might be affecting it?", isUser: true },
                { message: "I'm sorry to hear you're feeling stressed. Mood fluctuations are completely normal, and there are many factors that can influence how we feel. Let's explore some patterns together. Can you tell me about your sleep schedule lately?", isUser: false },
                { message: "My sleep has been terrible. I've been staying up late working and then I can't fall asleep because my mind is racing.", isUser: true },
                { message: "Sleep quality has a huge impact on mood and stress levels. When we don't get enough restorative sleep, our emotional regulation suffers. Here are some strategies that can help:\n\n**Sleep Hygiene Tips:**\nâ¢ Set a consistent bedtime routine\nâ¢ Avoid screens 1 hour before bed\nâ¢ Try relaxation techniques like deep breathing\nâ¢ Keep your bedroom cool and dark\n\n**For Racing Thoughts:**\nâ¢ Keep a journal by your bed to write down worries\nâ¢ Practice the 4-7-8 breathing technique\nâ¢ Try progressive muscle relaxation\n\nHow does your diet and exercise routine look? These also significantly impact mood.", isUser: false },
                { message: "I've been eating a lot of takeout and haven't exercised in weeks. I know I should but I just feel too tired and overwhelmed.", isUser: true },
                { message: "That's a very common cycle - stress leads to poor sleep and eating habits, which then increases stress. Let's break this gently:\n\n**Small Steps to Start:**\nâ¢ 10-minute walks during lunch breaks\nâ¢ Prepare simple, nutritious meals (even just adding a salad to takeout helps)\nâ¢ Set a phone alarm for bedtime routine\n\n**Mood Tracking Suggestion:**\nI recommend tracking your mood, sleep, food, and activity for a week. This will help us identify patterns and triggers. Would you like me to suggest a simple tracking method?", isUser: false }
            ],
            'Fasting schedule setup': [
                { message: "I'm interested in trying intermittent fasting but I'm not sure how to start safely. Can you help me set up a schedule?", isUser: true },
                { message: "Great choice! Intermittent fasting can have wonderful health benefits when done properly. Let's start with some basics. Have you done any form of fasting before, and do you have any medical conditions I should know about?", isUser: false },
                { message: "I've never done fasting before, and I'm generally healthy. I just want to try it for weight management and the health benefits I've heard about.", isUser: true },
                { message: "Perfect! For beginners, I recommend starting with the 16:8 method - it's the most sustainable and research-backed approach.\n\n**16:8 Method:**\nâ¢ Fast for 16 hours, eat within 8 hours\nâ¢ Example: Eat between 12 PM - 8 PM, fast from 8 PM - 12 PM next day\nâ¢ You can drink water, black coffee, or plain tea during fasting\n\n**Getting Started:**\nâ¢ Week 1-2: Try 12:12 (12 hour fast) to ease in\nâ¢ Week 3+: Progress to 16:8\nâ¢ Listen to your body and adjust as needed\n\nWhat's your current eating schedule like? This will help me suggest the best fasting window for your lifestyle.", isUser: false },
                { message: "I usually eat breakfast around 7 AM, lunch at noon, and dinner around 7 PM. I also tend to snack in the evening while watching TV.", isUser: true },
                { message: "Based on your current schedule, here are two options:\n\n**Option 1: Skip Breakfast**\nâ¢ Eating window: 12 PM - 8 PM\nâ¢ Keep your lunch and dinner times\nâ¢ Eliminates evening snacking naturally\n\n**Option 2: Early Eating**\nâ¢ Eating window: 10 AM - 6 PM\nâ¢ Early breakfast, normal lunch, earlier dinner\nâ¢ Better for morning energy needs\n\n**Tips for Success:**\nâ¢ Stay hydrated during fasting hours\nâ¢ Keep busy during typical snack times\nâ¢ Plan nutritious meals during eating windows\nâ¢ Start gradually - don't rush the process\n\nWhich option feels more doable for your lifestyle?", isUser: false }
            ],
            'Exercise routine planning': [
                { message: "I want to start working out regularly but I'm a complete beginner. Can you help me create a routine that won't overwhelm me?", isUser: true },
                { message: "Absolutely! Starting a fitness journey is exciting, and I love that you want to begin gradually. That's the key to long-term success. Tell me about your current activity level and any physical limitations or preferences you have.", isUser: false },
                { message: "I'm pretty sedentary right now - I work at a desk all day. No major physical limitations, but I get winded easily. I prefer working out at home if possible.", isUser: true },
                { message: "Perfect! Home workouts are convenient and effective. Let's start with a beginner-friendly routine that builds gradually:\n\n**Week 1-2: Foundation Building**\nâ¢ 3 days per week, 15-20 minutes\nâ¢ Focus: Basic movements and building habit\n\n**Sample Beginner Routine:**\nâ¢ 5-minute warm-up (marching in place, arm circles)\nâ¢ 10 minutes: Bodyweight exercises (modified push-ups, squats, planks)\nâ¢ 5-minute cool-down (stretching)\n\n**Progression Plan:**\nâ¢ Week 3-4: Increase to 25 minutes\nâ¢ Week 5-6: Add 4th workout day\nâ¢ Week 7+: Introduce new exercises\n\nWould you like me to detail specific exercises for your first week?", isUser: false },
                { message: "Yes, please! And how do I know if I'm pushing myself too hard or not hard enough?", isUser: true },
                { message: "Great question! Here's your detailed first week plan:\n\n**Beginner Workout (3x per week):**\n\n**Warm-up (5 min):**\nâ¢ Marching in place - 2 minutes\nâ¢ Arm circles - 30 seconds each direction\nâ¢ Gentle stretches - 2 minutes\n\n**Main Workout (10 min):**\nâ¢ Wall push-ups - 2 sets of 5-8 reps\nâ¢ Chair-assisted squats - 2 sets of 8-10 reps\nâ¢ Modified plank (knees down) - 2 sets of 15-20 seconds\nâ¢ Standing marches - 2 sets of 20 (10 each leg)\n\n**Cool-down (5 min):**\nâ¢ Deep breathing and stretching\n\n**Intensity Guidelines:**\nâ¢ You should be able to hold a conversation\nâ¢ Slight breathlessness is good, gasping is too much\nâ¢ Muscle fatigue is normal, sharp pain is not\nâ¢ Rate of Perceived Exertion: Aim for 5-6 out of 10\n\nHow does this sound for getting started?", isUser: false }
            ]
        };

        function selectChat(chatElement) {
            // Clear all highlights (tools and chats) - this ensures only one item is selected
            updateNavigationHighlight('none');

            // Highlight selected chat
            chatElement.classList.add('bg-nuri-bg-medium', 'text-nuri-primary-dark');
            chatElement.classList.remove('text-gray-600');

            // Get chat title from the element
            const chatTitle = chatElement.querySelector('span').textContent.trim();

            // Load conversation history for this chat
            loadConversationHistory(chatTitle);

            // Close sidebar on mobile when chat is selected
            if (window.innerWidth < 1024) {
                closeSidebar();
            }
        }

        function loadConversationHistory(chatTitle) {
            // First, ensure we're on the chat page (not tool page)
            currentPage = 'chat';
            chatPage.classList.remove('hidden');
            toolPage.classList.add('hidden');

            // Switch to conversation state
            isInitialState = false;
            initialState.classList.add('hidden');
            conversationState.classList.remove('hidden');
            conversationInput.classList.remove('hidden');

            // Handle mobile inputs
            if (mobileInitialInput) {
                mobileInitialInput.classList.add('hidden');
            }
            if (mobileConversationInput) {
                mobileConversationInput.classList.remove('hidden');
            }

            // Clear existing messages
            messagesContainer.innerHTML = '';

            // Load conversation data
            const conversation = sampleConversations[chatTitle];
            if (conversation) {
                // Add each message with a slight delay for better UX
                conversation.forEach((msg, index) => {
                    setTimeout(() => {
                        addMessage(msg.message, msg.isUser);
                    }, index * 100); // 100ms delay between messages
                });
            }

            // Update mobile title
            mobileTitle.textContent = chatTitle;
        }

        function updateNavigationHighlight(activeType) {
            // Clear all tool button highlights
            const toolButtons = document.querySelectorAll('.tool-button');
            toolButtons.forEach(btn => {
                btn.classList.remove('bg-nuri-bg-medium', 'text-nuri-primary-dark');
                btn.classList.add('text-gray-700');
            });

            // Clear all chat highlights
            const chatItems = document.querySelectorAll('.px-4.pb-4 .space-y-1 > div');
            chatItems.forEach(item => {
                item.classList.remove('bg-nuri-bg-medium', 'text-nuri-primary-dark');
                item.classList.add('text-gray-600');
            });

            // New Chat button should never be highlighted (always stays in normal state)
            const newChatBtn = document.getElementById('new-chat');
            if (newChatBtn) {
                newChatBtn.classList.remove('bg-nuri-bg-medium', 'text-nuri-primary-dark');
                newChatBtn.classList.add('text-gray-700');
            }

            // Highlight active item (only tools, never New Chat)
            if (activeType !== 'chat') {
                const activeBtn = document.getElementById(activeType + '-tool');
                if (activeBtn) {
                    activeBtn.classList.add('bg-nuri-bg-medium', 'text-nuri-primary-dark');
                    activeBtn.classList.remove('text-gray-700');
                }
            }
        }

        function loadToolPage(toolType) {
            currentPage = toolType;

            // Hide chat page, show tool page
            chatPage.classList.add('hidden');
            toolPage.classList.remove('hidden');

            // Load appropriate tool page
            const toolUrls = {
                'wellness': 'wellness-tools.html',
                'nutrition': 'nutrition-tools.html',
                'exercise': 'exercise-tools.html'
            };

            if (toolUrls[toolType]) {
                toolFrame.src = toolUrls[toolType];

                // Update mobile title
                const titles = {
                    'wellness': 'Wellness Tools',
                    'nutrition': 'Nutrition Tools',
                    'exercise': 'Exercise Tools'
                };
                mobileTitle.textContent = titles[toolType] || 'Nuri Tools';

                // Update navigation highlighting
                updateNavigationHighlight(toolType);

                // Close sidebar on mobile when item is selected
                if (window.innerWidth < 1024) {
                    closeSidebar();
                }
            }
        }

        // State management
        let isInitialState = true;

        function switchToConversationState() {
            if (!isInitialState) return;

            isInitialState = false;

            // Fade out initial state
            initialState.style.opacity = '0';

            setTimeout(() => {
                // Hide initial state
                initialState.classList.add('hidden');

                // Hide mobile initial input and show mobile conversation input
                if (mobileInitialInput) {
                    mobileInitialInput.classList.add('hidden');
                }
                if (mobileConversationInput) {
                    mobileConversationInput.classList.remove('hidden');
                }

                // Show conversation state with fade in
                conversationState.classList.remove('hidden');
                conversationInput.classList.remove('hidden');

                // Add fade in animation
                conversationState.classList.add('fade-in');
                conversationInput.classList.add('fade-in');

                // Focus on appropriate input based on screen size
                setTimeout(() => {
                    if (window.innerWidth >= 768) {
                        messageInput?.focus();
                    } else {
                        mobileMessageInput?.focus();
                    }
                }, 100);
            }, 300);
        }

        // Function to convert basic markdown to HTML
        function markdownToHtml(text) {
            // Convert line breaks to <br> tags
            let html = text.replace(/\n/g, '<br>');

            // Convert **bold** to <strong>
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            // Convert bullet points (â¢ or -) to proper list items
            html = html.replace(/^[â¢\-]\s+(.+)$/gm, '<li>$1</li>');

            // Wrap consecutive list items in <ul> tags
            html = html.replace(/(<li>.*<\/li>)(\s*<br>\s*<li>.*<\/li>)*/g, function(match) {
                // Remove <br> tags between list items
                const cleanMatch = match.replace(/<br>\s*(?=<li>)/g, '');
                return '<ul class="list-disc list-inside space-y-1 my-2">' + cleanMatch + '</ul>';
            });

            // Convert section headers (text followed by colon and line break)
            html = html.replace(/\*\*([^*]+):\*\*<br>/g, '<div class="font-semibold text-nuri-primary-dark mt-3 mb-1">$1:</div>');

            // Clean up any remaining <br> tags that are now unnecessary
            html = html.replace(/<br>\s*<ul>/g, '<ul>');
            html = html.replace(/<\/ul>\s*<br>/g, '</ul>');

            return html;
        }

        function addMessage(content, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = isUser ? 'flex justify-end' : 'flex justify-start';

            // Convert markdown to HTML for better formatting
            const formattedContent = isUser ? content : markdownToHtml(content);

            if (isUser) {
                messageDiv.innerHTML = `
                    <div class="flex items-start space-x-3 max-w-2xl">
                        <div class="px-4 py-3 rounded-2xl rounded-tr-md message-animate" style="background-color: #e9e9e980; color: #1f2937;">
                            <div>${formattedContent}</div>
                        </div>
                        <div class="w-8 h-8 bg-gray-400 rounded-full flex items-center justify-center flex-shrink-0">
                            <i data-lucide="user" class="w-4 h-4 text-white"></i>
                        </div>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="flex items-start space-x-3 max-w-2xl">
                        <div class="w-8 h-8 bg-gray-100 rounded-full flex items-center justify-center flex-shrink-0">
                            <i data-lucide="bot" class="w-4 h-4 text-gray-600"></i>
                        </div>
                        <div class="bg-nuri-bg-light text-nuri-primary-dark px-4 py-3 rounded-2xl rounded-tl-md message-animate">
                            <div>${formattedContent}</div>
                        </div>
                    </div>
                `;
            }

            messagesContainer.appendChild(messageDiv);

            // Re-initialize Lucide icons for new elements
            lucide.createIcons();

            // Scroll to bottom
            conversationState.scrollTop = conversationState.scrollHeight;
        }

        // Initial state input functionality (Desktop)
        initialMessageInput?.addEventListener('input', function() {
            const hasText = this.value.trim().length > 0;
            initialSendButton.disabled = !hasText;

            // Sync with mobile input
            if (mobileInitialMessageInput) {
                mobileInitialMessageInput.value = this.value;
                mobileInitialSendButton.disabled = !hasText;

                // Update mobile send button style
                if (hasText) {
                    mobileInitialSendButton.classList.remove('bg-gray-200', 'text-gray-400');
                    mobileInitialSendButton.classList.add('bg-nuri-primary', 'text-white');
                } else {
                    mobileInitialSendButton.classList.remove('bg-nuri-primary', 'text-white');
                    mobileInitialSendButton.classList.add('bg-gray-200', 'text-gray-400');
                }
            }

            // Update send button style based on content
            if (hasText) {
                initialSendButton.classList.remove('bg-gray-200', 'text-gray-400');
                initialSendButton.classList.add('bg-nuri-primary', 'text-white');
            } else {
                initialSendButton.classList.remove('bg-nuri-primary', 'text-white');
                initialSendButton.classList.add('bg-gray-200', 'text-gray-400');
            }

            // Auto-resize textarea
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 200) + 'px';
        });

        // Mobile initial state input functionality
        mobileInitialMessageInput?.addEventListener('input', function() {
            const hasText = this.value.trim().length > 0;
            mobileInitialSendButton.disabled = !hasText;

            // Sync with desktop input
            if (initialMessageInput) {
                initialMessageInput.value = this.value;
                initialSendButton.disabled = !hasText;

                // Update desktop send button style
                if (hasText) {
                    initialSendButton.classList.remove('bg-gray-200', 'text-gray-400');
                    initialSendButton.classList.add('bg-nuri-primary', 'text-white');
                } else {
                    initialSendButton.classList.remove('bg-nuri-primary', 'text-white');
                    initialSendButton.classList.add('bg-gray-200', 'text-gray-400');
                }
            }

            // Update send button style based on content
            if (hasText) {
                mobileInitialSendButton.classList.remove('bg-gray-200', 'text-gray-400');
                mobileInitialSendButton.classList.add('bg-nuri-primary', 'text-white');
            } else {
                mobileInitialSendButton.classList.remove('bg-nuri-primary', 'text-white');
                mobileInitialSendButton.classList.add('bg-gray-200', 'text-gray-400');
            }

            // Auto-resize textarea
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 200) + 'px';
        });

        // Conversation state input functionality (Desktop)
        messageInput?.addEventListener('input', function() {
            const hasText = this.value.trim().length > 0;
            sendButton.disabled = !hasText;

            // Sync with mobile input
            if (mobileMessageInput) {
                mobileMessageInput.value = this.value;
                mobileSendButton.disabled = !hasText;

                // Update mobile send button style
                if (hasText) {
                    mobileSendButton.classList.remove('bg-gray-200', 'text-gray-400');
                    mobileSendButton.classList.add('bg-nuri-primary', 'text-white');
                } else {
                    mobileSendButton.classList.remove('bg-nuri-primary', 'text-white');
                    mobileSendButton.classList.add('bg-gray-200', 'text-gray-400');
                }
            }

            // Update send button style based on content
            if (hasText) {
                sendButton.classList.remove('bg-gray-200', 'text-gray-400');
                sendButton.classList.add('bg-nuri-primary', 'text-white');
            } else {
                sendButton.classList.remove('bg-nuri-primary', 'text-white');
                sendButton.classList.add('bg-gray-200', 'text-gray-400');
            }

            // Auto-resize textarea
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 200) + 'px';
        });

        // Mobile conversation state input functionality
        mobileMessageInput?.addEventListener('input', function() {
            const hasText = this.value.trim().length > 0;
            mobileSendButton.disabled = !hasText;

            // Sync with desktop input
            if (messageInput) {
                messageInput.value = this.value;
                sendButton.disabled = !hasText;

                // Update desktop send button style
                if (hasText) {
                    sendButton.classList.remove('bg-gray-200', 'text-gray-400');
                    sendButton.classList.add('bg-nuri-primary', 'text-white');
                } else {
                    sendButton.classList.remove('bg-nuri-primary', 'text-white');
                    sendButton.classList.add('bg-gray-200', 'text-gray-400');
                }
            }

            // Update send button style based on content
            if (hasText) {
                mobileSendButton.classList.remove('bg-gray-200', 'text-gray-400');
                mobileSendButton.classList.add('bg-nuri-primary', 'text-white');
            } else {
                mobileSendButton.classList.remove('bg-nuri-primary', 'text-white');
                mobileSendButton.classList.add('bg-gray-200', 'text-gray-400');
            }

            // Auto-resize textarea
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 200) + 'px';
        });

        // Send message functionality for initial state
        function sendInitialMessage() {
            // Get message from either desktop or mobile input
            const desktopMessage = initialMessageInput?.value.trim() || '';
            const mobileMessage = mobileInitialMessageInput?.value.trim() || '';
            const message = desktopMessage || mobileMessage;

            if (!message) return;

            // Switch to conversation state
            switchToConversationState();

            // Add user message
            addMessage(message, true);

            // Clear both inputs
            if (initialMessageInput) {
                initialMessageInput.value = '';
                initialMessageInput.style.height = 'auto';
                initialSendButton.disabled = true;
                initialSendButton.classList.remove('bg-nuri-primary', 'text-white');
                initialSendButton.classList.add('bg-gray-200', 'text-gray-400');
            }
            if (mobileInitialMessageInput) {
                mobileInitialMessageInput.value = '';
                mobileInitialMessageInput.style.height = 'auto';
                mobileInitialSendButton.disabled = true;
                mobileInitialSendButton.classList.remove('bg-nuri-primary', 'text-white');
                mobileInitialSendButton.classList.add('bg-gray-200', 'text-gray-400');
            }

            // Simulate AI response after a delay
            setTimeout(() => {
                addMessage("I'd be happy to help you with that! Let me provide you with some personalized recommendations based on your wellness goals.");
            }, 1000);
        }

        // Send message functionality for conversation state
        function sendMessage() {
            // Get message from either desktop or mobile input
            const desktopMessage = messageInput?.value.trim() || '';
            const mobileMessage = mobileMessageInput?.value.trim() || '';
            const message = desktopMessage || mobileMessage;

            if (!message) return;

            // Add user message
            addMessage(message, true);

            // Clear both inputs
            if (messageInput) {
                messageInput.value = '';
                messageInput.style.height = 'auto';
                sendButton.disabled = true;
                sendButton.classList.remove('bg-nuri-primary', 'text-white');
                sendButton.classList.add('bg-gray-200', 'text-gray-400');
            }
            if (mobileMessageInput) {
                mobileMessageInput.value = '';
                mobileMessageInput.style.height = 'auto';
                mobileSendButton.disabled = true;
                mobileSendButton.classList.remove('bg-nuri-primary', 'text-white');
                mobileSendButton.classList.add('bg-gray-200', 'text-gray-400');
            }

            // Simulate AI response after a delay
            setTimeout(() => {
                addMessage("Thank you for your message! I'm here to help you with your wellness journey.");
            }, 1000);
        }

        // Event listeners for initial state (Desktop)
        initialSendButton?.addEventListener('click', sendInitialMessage);
        initialMessageInput?.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendInitialMessage();
            }
        });

        // Event listeners for mobile initial state
        mobileInitialSendButton?.addEventListener('click', sendInitialMessage);
        mobileInitialMessageInput?.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendInitialMessage();
            }
        });

        // Event listeners for conversation state (Desktop)
        sendButton?.addEventListener('click', sendMessage);
        messageInput?.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Event listeners for mobile conversation state
        mobileSendButton?.addEventListener('click', sendMessage);
        mobileMessageInput?.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Initial state suggestion functionality (removed since no suggestion buttons)
        // initialSuggestionBtns.forEach(btn => {
        //     btn.addEventListener('click', function() {
        //         const suggestion = this.textContent.trim();
        //         initialMessageInput.value = suggestion;
        //         initialMessageInput.focus();
        //         initialSendButton.disabled = false;
        //
        //         // Update send button style
        //         initialSendButton.classList.remove('bg-gray-200', 'text-gray-400');
        //         initialSendButton.classList.add('bg-gray-800', 'text-white');
        //
        //         // Auto-resize textarea
        //         initialMessageInput.style.height = 'auto';
        //         initialMessageInput.style.height = Math.min(initialMessageInput.scrollHeight, 200) + 'px';
        //     });
        // });



        // Responsive behavior
        function handleResize() {
            if (window.innerWidth >= 1024) {
                // Desktop: always show sidebar
                sidebar.classList.remove('-translate-x-full');
                sidebarOverlay.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');

                // Hide mobile input on desktop
                if (mobileInitialInput) {
                    mobileInitialInput.classList.add('hidden');
                }
            } else {
                // Mobile/Tablet: hide sidebar by default
                if (!sidebarOverlay.classList.contains('hidden')) {
                    // Only close if overlay is visible (sidebar is open)
                    closeSidebar();
                }

                // Show mobile input on mobile if in initial state
                if (isInitialState && mobileInitialInput) {
                    mobileInitialInput.classList.remove('hidden');
                }
            }
        }

        window.addEventListener('resize', handleResize);
        handleResize(); // Initial call

        // Initialize mobile input visibility on page load
        document.addEventListener('DOMContentLoaded', function() {
            if (window.innerWidth < 768 && isInitialState && mobileInitialInput) {
                mobileInitialInput.classList.remove('hidden');
            }
        });

        // Modal functionality (only for settings)
        const modalContainer = document.getElementById('modalContainer');
        const modalFrame = document.getElementById('modalFrame');

        function openModal(type) {
            const modalUrls = {
                'settings': 'settings-modal.html'
            };

            if (modalUrls[type]) {
                modalFrame.src = modalUrls[type];
                modalContainer.classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
            }
        }

        function closeModal() {
            modalContainer.classList.add('hidden');
            modalFrame.src = '';
            document.body.classList.remove('overflow-hidden');
        }

        // Listen for modal close messages from iframe modals
        window.addEventListener('message', function(event) {
            if (event.data === 'closeModal') {
                closeModal();
            }
        });

        // Listen for close modal messages from iframes
        window.addEventListener('message', function(event) {
            if (event.data === 'closeModal') {
                closeModal();
            }
        });

        // Close modal on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && !modalContainer.classList.contains('hidden')) {
                closeModal();
            }
        });

        // Profile dropdown functionality
        const profileMenuButton = document.getElementById('profileMenuButton');
        const profileDropdown = document.getElementById('profileDropdown');

        profileMenuButton?.addEventListener('click', function(e) {
            e.stopPropagation();
            profileDropdown.classList.toggle('hidden');
        });

        // Mobile profile button removed

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!profileMenuButton?.contains(e.target) && !profileDropdown?.contains(e.target)) {
                profileDropdown?.classList.add('hidden');
            }
        });

        // Close dropdown on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                profileDropdown?.classList.add('hidden');
            }
        });

        // User avatar color generation
        function generateAvatarColor(name) {
            const colors = [
                '#10a37f', // ChatGPT green
                '#ff6b6b', // Red
                '#4ecdc4', // Teal
                '#45b7d1', // Blue
                '#96ceb4', // Light green
                '#feca57', // Yellow
                '#ff9ff3', // Pink
                '#54a0ff', // Light blue
                '#5f27cd', // Purple
                '#00d2d3'  // Cyan
            ];

            let hash = 0;
            for (let i = 0; i < name.length; i++) {
                hash = name.charCodeAt(i) + ((hash << 5) - hash);
            }

            return colors[Math.abs(hash) % colors.length];
        }

        function getUserInitials(name) {
            return name.split(' ')
                      .map(word => word.charAt(0).toUpperCase())
                      .join('')
                      .substring(0, 2);
        }

        // Initialize user avatar with protection against overwrites
        function initializeUserAvatar(userName = 'John Doe', accountType = 'Free') {
            const userAvatar = document.getElementById('userAvatar');

            if (userAvatar) {
                const initials = getUserInitials(userName);
                const color = generateAvatarColor(userName);

                // Function to set avatar content
                function setAvatarContent() {
                    userAvatar.textContent = initials;
                    userAvatar.style.backgroundColor = color;
                    console.log('Avatar set to:', initials, 'with color:', color);
                }

                // Set initial content
                setAvatarContent();

                // Create a MutationObserver to watch for changes to the avatar
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'childList' || mutation.type === 'characterData') {
                            if (userAvatar.textContent !== initials) {
                                console.log('Avatar content changed from', userAvatar.textContent, 'back to', initials);
                                setAvatarContent();
                            }
                        }
                    });
                });

                // Start observing
                observer.observe(userAvatar, {
                    childList: true,
                    characterData: true,
                    subtree: true
                });
            }

            // Update name and account type in profile button text areas only
            const nameElement = document.querySelector('#profileMenuButton .text-sm.font-medium');
            const accountElement = document.querySelector('#profileMenuButton .text-xs.text-gray-500');

            if (nameElement) {
                nameElement.textContent = userName;
                console.log('Name updated to:', userName);
            }
            if (accountElement) {
                accountElement.textContent = accountType;
                console.log('Account type updated to:', accountType);
            }
        }

        // Initialize avatar on page load with delay to ensure all scripts are loaded
        setTimeout(() => {
            initializeUserAvatar();
        }, 500);

        // Also initialize after Lucide icons are created
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                initializeUserAvatar();
            }, 1000);
        });

        // Initialize Lucide icons first
        lucide.createIcons();

        // Search dialog functionality
        const searchDialog = document.getElementById('searchDialog');
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');

        function openSearchDialog() {
            searchDialog.classList.remove('hidden');
            setTimeout(() => {
                searchInput.focus();
            }, 100);
            document.body.classList.add('overflow-hidden');
        }

        function closeSearchDialog() {
            searchDialog.classList.add('hidden');
            searchInput.value = '';
            document.body.classList.remove('overflow-hidden');
            // Reset to default results
            showDefaultSearchResults();
        }

        function showDefaultSearchResults() {
            searchResults.innerHTML = `
                <!-- Default results when no search -->
                <div class="px-4 py-2">
                    <div class="flex items-center space-x-3 p-3 hover:bg-gray-100 rounded-lg cursor-pointer" onclick="loadChatPage(); closeSearchDialog();">
                        <i data-lucide="plus" class="w-4 h-4 text-gray-500"></i>
                        <span class="text-sm text-gray-900">New chat</span>
                    </div>
                </div>

                <!-- Chat History Section -->
                <div class="px-4 py-2">
                    <div class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2 px-3">Today</div>
                    <div class="space-y-1">
                        <div class="flex items-center space-x-3 p-3 hover:bg-gray-100 rounded-lg cursor-pointer">
                            <i data-lucide="message-circle" class="w-4 h-4 text-gray-500"></i>
                            <span class="text-sm text-gray-900">Nutrition planning help</span>
                        </div>
                        <div class="flex items-center space-x-3 p-3 hover:bg-gray-100 rounded-lg cursor-pointer">
                            <i data-lucide="message-circle" class="w-4 h-4 text-gray-500"></i>
                            <span class="text-sm text-gray-900">Mood tracking insights</span>
                        </div>
                    </div>
                </div>

                <div class="px-4 py-2">
                    <div class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2 px-3">Yesterday</div>
                    <div class="space-y-1">
                        <div class="flex items-center space-x-3 p-3 hover:bg-gray-100 rounded-lg cursor-pointer">
                            <i data-lucide="message-circle" class="w-4 h-4 text-gray-500"></i>
                            <span class="text-sm text-gray-900">Fasting schedule setup</span>
                        </div>
                        <div class="flex items-center space-x-3 p-3 hover:bg-gray-100 rounded-lg cursor-pointer">
                            <i data-lucide="message-circle" class="w-4 h-4 text-gray-500"></i>
                            <span class="text-sm text-gray-900">Exercise routine planning</span>
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        // Search functionality
        searchInput?.addEventListener('input', function() {
            const query = this.value.toLowerCase().trim();

            if (query === '') {
                showDefaultSearchResults();
                return;
            }

            // Filter chats based on search query
            const chats = [
                { title: 'Nutrition planning help', date: 'Today' },
                { title: 'Mood tracking insights', date: 'Today' },
                { title: 'Fasting schedule setup', date: 'Yesterday' },
                { title: 'Exercise routine planning', date: 'Yesterday' },
                { title: 'Weight loss goals discussion', date: 'Last week' },
                { title: 'Healthy meal prep ideas', date: 'Last week' }
            ];

            const filteredChats = chats.filter(chat =>
                chat.title.toLowerCase().includes(query)
            );

            if (filteredChats.length === 0) {
                searchResults.innerHTML = `
                    <div class="px-4 py-8 text-center">
                        <i data-lucide="search" class="w-8 h-8 text-gray-400 mx-auto mb-2"></i>
                        <p class="text-sm text-gray-500">No chats found for "${query}"</p>
                    </div>
                `;
            } else {
                let resultsHTML = '';
                const groupedChats = {};

                filteredChats.forEach(chat => {
                    if (!groupedChats[chat.date]) {
                        groupedChats[chat.date] = [];
                    }
                    groupedChats[chat.date].push(chat);
                });

                Object.keys(groupedChats).forEach(date => {
                    resultsHTML += `
                        <div class="px-4 py-2">
                            <div class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2 px-3">${date}</div>
                            <div class="space-y-1">
                    `;

                    groupedChats[date].forEach(chat => {
                        resultsHTML += `
                            <div class="flex items-center space-x-3 p-3 hover:bg-gray-100 rounded-lg cursor-pointer">
                                <i data-lucide="message-circle" class="w-4 h-4 text-gray-500"></i>
                                <span class="text-sm text-gray-900">${chat.title}</span>
                            </div>
                        `;
                    });

                    resultsHTML += `
                            </div>
                        </div>
                    `;
                });

                searchResults.innerHTML = resultsHTML;
            }

            lucide.createIcons();
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl+K or Cmd+K to open search
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                openSearchDialog();
            }

            // Escape to close search
            if (e.key === 'Escape' && !searchDialog.classList.contains('hidden')) {
                closeSearchDialog();
            }
        });

        // Close search when clicking outside
        searchDialog?.addEventListener('click', function(e) {
            if (e.target === searchDialog) {
                closeSearchDialog();
            }
        });

        // Make functions globally available
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.loadChatPage = loadChatPage;
        window.loadToolPage = loadToolPage;
        window.initializeUserAvatar = initializeUserAvatar;
        window.openSearchDialog = openSearchDialog;
        window.closeSearchDialog = closeSearchDialog;
    </script>
</body>
</html>
